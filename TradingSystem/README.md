# ORB戦略トレーディングシステム

## 概要

Open Range Breakout (ORB) 戦略を使用したバックテストシステムです。
設定ファイル（YAML）で簡単に銘柄やパラメータを変更でき、データベース優先のデータ取得により効率的な運用が可能です。

## 主な機能

- **簡単な銘柄指定**: `config/strategy_config.yaml` で銘柄リストを簡単に編集可能
- **バックテストのみ**: ライブトレーディングは含まれません（安全）
- **データベース優先**: PostgreSQL → Refinitiv API → DBに保存（効率的）
- **豊富なレポート**: 日次レポート、チャート、サマリーを自動生成
- **LONG/SHORT分析**: エントリー方向別のトレード分析と可視化
- **日時別保存**: 実行日時ごとにフォルダを作成し、全レポートを一括管理
- **パラメータ設定**: 損切り、利確、エントリー時間、オープンレンジ時間を柔軟に設定
- **拡張可能**: 将来的に複数戦略を追加可能な設計

## システム構成

```
TradingSystem/
├── config/
│   └── strategy_config.yaml       # 設定ファイル（ここを編集）
├── src/
│   ├── backtester/
│   │   └── engine.py              # バックテストエンジン
│   ├── data/
│   │   ├── refinitiv_client.py    # Refinitiv APIクライアント
│   │   └── db_manager.py          # データベース管理
│   ├── reporting/
│   │   └── report_generator.py   # レポート生成器
│   └── strategy/
│       └── range_breakout.py      # ORB戦略ロジック
├── Output/                         # レポート出力先
│   ├── YYYYMMDD_HHMMSS/           # 実行日時別フォルダ（全レポート格納）
│   └── trading_system.log         # システムログ
├── run_trading_system.py           # メインスクリプト
└── README.md                       # このファイル
```

## 使い方

### 1. 設定ファイルの編集

`config/strategy_config.yaml` を開いて、以下の項目を必要に応じて編集します：

#### 銘柄リストの変更

```yaml
stocks:
  # テクノロジーセクター
  - ["6762.T", "TDK"]
  - ["6857.T", "アドバンテスト"]
  - ["6758.T", "キーエンス"]

  # 新しい銘柄を追加
  - ["7203.T", "トヨタ自動車"]
  - ["9983.T", "ファーストリテイリング"]
```

#### パラメータの変更

```yaml
orb_strategy:
  # オープンレンジ期間
  open_range:
    start_time: "09:05"    # 開始時刻（JST）
    end_time: "09:15"      # 終了時刻（JST）

  # エントリー期間
  entry_window:
    start_time: "09:15"    # エントリー開始時刻
    end_time: "11:00"      # エントリー終了時刻

  # 強制決済時刻
  force_exit_time: "15:00"

  # 利益目標（4% = 0.04）
  profit_target: 0.04

  # 損切りライン（0.75% = 0.0075）
  stop_loss: 0.0075
```

#### バックテスト期間の変更

```yaml
backtest_period:
  start_date: "2025-05-14"    # 開始日（YYYY-MM-DD）
  end_date: "2025-11-12"      # 終了日（YYYY-MM-DD）
```

#### 資金配分の変更

```yaml
capital:
  per_stock: 5000000      # 各銘柄に配分する資金（円）
  commission_rate: 0.001  # 手数料率（0.1%）
```

### 2. システム実行

```bash
# メインスクリプトを実行
python run_trading_system.py
```

実行すると以下の処理が順次実行されます：

1. 設定ファイルの読み込み
2. データベース接続（PostgreSQL）
3. Refinitiv API接続
4. 各銘柄のバックテスト実行
5. レポート生成（CSV, PNG, TXT）

### 3. レポートの確認

実行が完了すると、`Output/YYYYMMDD_HHMMSS/` フォルダ以下にレポートが生成されます：

#### レポートファイル一覧

実行日時別のフォルダに全てのレポートが格納されます：

```
Output/20251115_163104/  # 例：2025年11月15日 16:31:04実行
├── summary.csv          # 全銘柄の統計情報
├── summary.txt          # テキスト形式のサマリー
├── summary_charts.png   # 全銘柄の比較チャート
├── daily_pl_heatmap.png # 日次損益ヒートマップ
├── 6762.T_trades.csv    # 銘柄別トレード履歴
├── 6762.T_equity.csv    # 銘柄別エクイティカーブ
└── 6762.T_chart.png     # 銘柄別チャート
```

#### サマリーレポートの内容

- **統計情報**: 勝率、平均損益、最大ドローダウン等
- **LONG/SHORT分析**: エントリー方向別のトレード数と損益
- **日次損益**: カレンダー形式のヒートマップ
- **比較チャート**: 全銘柄のパフォーマンス比較

#### システムログ

- `Output/trading_system.log` - 実行ログ（全実行の履歴）

## データ取得の仕組み

### データベース優先アプローチ

1. **データベース確認**: まずPostgreSQLデータベースから必要なデータを検索
2. **APIフォールバック**: データがない場合のみRefinitiv APIにアクセス
3. **自動保存**: APIから取得したデータを自動的にデータベースに保存
4. **再利用**: 次回以降はデータベースから高速に取得

このアプローチにより：
- API呼び出し回数を最小限に抑制
- バックテストの高速化
- データの永続化と再利用

## ORB戦略の説明

### 戦略概要

Open Range Breakout (ORB) は、取引開始直後の一定時間（オープンレンジ）の高値・安値をブレイクしたらエントリーする戦略です。

### エントリールール

1. **オープンレンジ**: 09:05～09:15の高値・安値を記録
2. **ブレイクアウト**:
   - **LONG**: オープンレンジの高値を上抜けたら買いエントリー
   - **SHORT**: オープンレンジの安値を下抜けたら売りエントリー
3. **エントリー時間**: 09:15～11:00
4. **ポジションサイズ**: 設定資金（デフォルト: 500万円）を株価で割った株数

### イグジットルール

以下のいずれかの条件で決済：

1. **利益目標**: エントリー価格から+4%に到達
2. **損切り**: エントリー価格から-0.75%に到達
3. **強制決済**: 15:00（取引終了時刻）に到達

## トラブルシューティング

### エラー: 設定ファイルが見つかりません

**解決方法**: `config/strategy_config.yaml` が存在することを確認してください。

### エラー: データベース接続失敗

**解決方法**:
1. PostgreSQLが起動していることを確認
2. `config/strategy_config.yaml` のデータベース設定を確認
3. データベースユーザーの権限を確認

### エラー: Refinitiv API接続失敗

**解決方法**:
1. Refinitiv Workspace (EIKON) が起動していることを確認
2. APIキーが正しいことを確認
3. ネットワーク接続を確認

## よくある質問

### Q1. 銘柄を追加・削除するには？

A1. `config/strategy_config.yaml` の `stocks` セクションを編集してください。

### Q2. ライブトレーディングはできますか？

A2. このシステムはバックテストのみを目的としています。ライブトレーディング機能はありません。

### Q3. 他の戦略を追加できますか？

A3. 設計上は可能ですが、現在はORB戦略のみ実装されています。
将来的には `src/strategy/` に新しい戦略クラスを追加し、設定ファイルで選択できるようにする予定です。

## 今後の拡張予定

- [ ] 複数戦略のサポート（移動平均クロス、ボリンジャーバンド等）
- [ ] パラメータ最適化機能（グリッドサーチ）
- [ ] Webダッシュボード（Flask/Dash）
- [ ] リアルタイムアラート機能
- [ ] 複数銘柄のポートフォリオ最適化

## ライセンス

このプロジェクトは個人使用を目的としています。
